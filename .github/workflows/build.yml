name: Build UltimateAdlibs

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PROJECT_NAME: UltimateAdlibs
  JUCER_FILE: UltimateAdlibs.jucer
  XCODE_PROJECT_PATH: Builds/MacOSX/UltimateAdlibs.xcodeproj
  BUILD_DIR: Builds/MacOSX/build/Release

jobs:
  build_mac:
    name: Build MacOS (Universal)
    # On reste sur macOS 14 (Sonoma) pour la stabilité avec JUCE 7
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Télécharger JUCE
      - name: Install JUCE
        run: |
          echo "Cloning JUCE 7.0.12..."
          git clone --depth 1 --branch 7.0.12 https://github.com/juce-framework/JUCE.git JUCE

      # 2. Compiler le Projucer avec CMAKE
      - name: Build Projucer using CMake
        run: |
          cd JUCE
          cmake . -B cmake-build -DJUCE_BUILD_EXTRAS=ON -DCMAKE_BUILD_TYPE=Release
          cmake --build cmake-build --target Projucer --config Release

      # 3. Générer le projet Xcode
      - name: Generate Xcode Project via Projucer
        run: |
          PROJUCER_APP=$(find JUCE/cmake-build -name Projucer -type f | grep "MacOS/Projucer" | head -n 1)
          chmod +x "$PROJUCER_APP"
          
          # Correction des chemins dans le .jucer
          sed -i '' 's/useGlobalPath="1"/useGlobalPath="0"/g' "${{ env.JUCER_FILE }}"
          sed -i '' 's|path=".*JUCE/modules"|path="JUCE/modules"|g' "${{ env.JUCER_FILE }}"

          "$PROJUCER_APP" --resave "${{ env.JUCER_FILE }}"

      # 4. DEBUG : Lister les schémas disponibles (Pour être sûr à 100%)
      - name: List Xcode Schemes
        run: |
          echo "Listing available schemes..."
          xcodebuild -project "${{ env.XCODE_PROJECT_PATH }}" -list

      # 5. Compiler la version AU (Audio Unit - Pour Logic Pro)
      - name: Build AU Plugin
        run: |
          echo "Building AU..."
          # On cible spécifiquement le schéma "UltimateAdlibs - AU"
          xcodebuild -project "${{ env.XCODE_PROJECT_PATH }}" \
            -scheme "${{ env.PROJECT_NAME }} - AU" \
            -configuration Release \
            -arch x86_64 -arch arm64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -allowProvisioningUpdates \
            build

      # 6. Compiler la version VST3 (Pour les autres DAWs)
      - name: Build VST3 Plugin
        run: |
          echo "Building VST3..."
          # On cible spécifiquement le schéma "UltimateAdlibs - VST3"
          xcodebuild -project "${{ env.XCODE_PROJECT_PATH }}" \
            -scheme "${{ env.PROJECT_NAME }} - VST3" \
            -configuration Release \
            -arch x86_64 -arch arm64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -allowProvisioningUpdates \
            build

      # 7. Zip et Upload
      - name: Zip Plugins
        run: |
          cd "${{ env.BUILD_DIR }}"
          ls -la
          
          # Vérification que le AU est bien là (Priorité absolue)
          if [ ! -d "${{ env.PROJECT_NAME }}.component" ]; then
            echo "::error::AU Plugin (.component) failed to build."
            exit 1
          fi

          zip -r "${{ env.PROJECT_NAME }}-Mac-VST3.zip" "${{ env.PROJECT_NAME }}.vst3"
          zip -r "${{ env.PROJECT_NAME }}-Mac-AU.zip" "${{ env.PROJECT_NAME }}.component"

      - name: Upload VST3 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-Mac-VST3
          path: ${{ env.BUILD_DIR }}/${{ env.PROJECT_NAME }}-Mac-VST3.zip

      - name: Upload AU Artifact (For Logic Pro)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-Mac-AU
          path: ${{ env.BUILD_DIR }}/${{ env.PROJECT_NAME }}-Mac-AU.zip
