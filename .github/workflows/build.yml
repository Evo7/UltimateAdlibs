name: Build UltimateAdlibs

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PROJECT_NAME: UltimateAdlibs
  JUCER_FILE: UltimateAdlibs.jucer
  XCODE_PROJECT_PATH: Builds/MacOSX/UltimateAdlibs.xcodeproj
  BUILD_DIR: Builds/MacOSX/build/Release

jobs:
  build_mac:
    name: Build MacOS (Universal)
    # UTILISATION DE LA DERNIÈRE VERSION DISPONIBLE (macOS 14/15 sur M1)
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ÉTAPE 1 : Télécharger JUCE 7.0.12 (Stable)
      - name: Install JUCE
        run: |
          echo "Cloning JUCE 7.0.12..."
          git clone --depth 1 --branch 7.0.12 https://github.com/juce-framework/JUCE.git JUCE

      # ÉTAPE 2 : Compiler le Projucer
      # Sur macos-latest, Xcode est déjà configuré, pas besoin de setup-xcode complexe
      - name: Build Projucer
        run: |
          echo "Building Projucer..."
          cd JUCE/extras/Projucer/Builds/MacOSX
          # On utilise -scheme pour éviter les erreurs de cibles
          xcodebuild -project Projucer.xcodeproj -scheme Projucer -configuration Release -allowProvisioningUpdates

      # ÉTAPE 3 : Générer le projet Xcode pour VOTRE plugin
      - name: Generate Xcode Project via Projucer
        run: |
          echo "Generating Xcode project from .jucer file..."
          PROJUCER_APP="./JUCE/extras/Projucer/Builds/MacOSX/build/Release/Projucer.app/Contents/MacOS/Projucer"
          chmod +x "$PROJUCER_APP"
          
          # Génération du dossier Builds/MacOSX qui vous manquait
          "$PROJUCER_APP" --resave "${{ env.JUCER_FILE }}"
          
          if [ ! -d "${{ env.XCODE_PROJECT_PATH }}" ]; then
            echo "::error::Failed to generate Xcode project!"
            exit 1
          fi

      # ÉTAPE 4 : Compiler le plugin (AU & VST3) en mode Universel (Intel + Apple Silicon)
      - name: Build Audio Plugin
        run: |
          # Le -arch x86_64 -arch arm64 assure que le plugin marche partout
          xcodebuild -project "${{ env.XCODE_PROJECT_PATH }}" \
            -scheme "${{ env.PROJECT_NAME }}" \
            -configuration Release \
            -arch x86_64 -arch arm64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -allowProvisioningUpdates \
            build

      # ÉTAPE 5 : Zip et Vérification
      - name: Zip Plugins
        run: |
          cd "${{ env.BUILD_DIR }}"
          
          if [ ! -d "${{ env.PROJECT_NAME }}.component" ]; then
            echo "::error::.component file missing! Check logs above."
            exit 1
          fi

          zip -r "${{ env.PROJECT_NAME }}-Mac-VST3.zip" "${{ env.PROJECT_NAME }}.vst3"
          zip -r "${{ env.PROJECT_NAME }}-Mac-AU.zip" "${{ env.PROJECT_NAME }}.component"

      - name: Upload VST3 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-Mac-VST3
          path: ${{ env.BUILD_DIR }}/${{ env.PROJECT_NAME }}-Mac-VST3.zip

      - name: Upload AU Artifact (For Logic Pro)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-Mac-AU
          path: ${{ env.BUILD_DIR }}/${{ env.PROJECT_NAME }}-Mac-AU.zip
